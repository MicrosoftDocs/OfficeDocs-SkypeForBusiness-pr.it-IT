---
title: Instradamento diretto di Sistema telefonico
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Protocolli di routing diretto
appliesto:
- Microsoft Teams
ms.openlocfilehash: 04e9507595ef721ced5d47eb58646559601c5cab
ms.sourcegitcommit: 8750f98d59e74e3835d762d510fb0e038c8f17eb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 04/20/2021
ms.locfileid: "51899127"
---
# <a name="direct-routing---sip-protocol"></a><span data-ttu-id="c85d0-103">Routing diretto - Protocollo SIP</span><span class="sxs-lookup"><span data-stu-id="c85d0-103">Direct Routing - SIP protocol</span></span>

<span data-ttu-id="c85d0-104">Questo articolo descrive come Il routing diretto implementa il protocollo SIP (Session Initiation Protocol).</span><span class="sxs-lookup"><span data-stu-id="c85d0-104">This article describes how Direct Routing implements the Session Initiation Protocol (SIP).</span></span> <span data-ttu-id="c85d0-105">Per instradare correttamente il traffico tra un session border controller (SBC) e il proxy SIP, alcuni parametri SIP devono avere valori specifici.</span><span class="sxs-lookup"><span data-stu-id="c85d0-105">To properly route traffic between a Session Border Controller (SBC) and the SIP proxy, some SIP parameters must have specific values.</span></span> <span data-ttu-id="c85d0-106">Questo articolo è rivolto agli amministratori vocali responsabili della configurazione della connessione tra il servizio SBC locale e il servizio proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-106">This article is intended for voice administrators who are responsible for configuring the connection between the on-premises SBC and the SIP proxy service.</span></span>

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a><span data-ttu-id="c85d0-107">Elaborazione della richiesta in arrivo: ricerca del tenant e dell'utente</span><span class="sxs-lookup"><span data-stu-id="c85d0-107">Processing the incoming request: finding the tenant and user</span></span>

<span data-ttu-id="c85d0-108">Prima di elaborare una chiamata in arrivo o in uscita, i messaggi OPTIONS vengono s scambiati tra il proxy SIP e il servizio SBC.</span><span class="sxs-lookup"><span data-stu-id="c85d0-108">Before an incoming or outbound call can be processed, OPTIONS messages are exchanged between SIP Proxy and the SBC.</span></span> <span data-ttu-id="c85d0-109">Questi messaggi OPTIONS consentono al proxy SIP di fornire le funzionalità consentite a SBC.</span><span class="sxs-lookup"><span data-stu-id="c85d0-109">These OPTIONS messages allow SIP Proxy to provide the allowed capabilities to SBC.</span></span> <span data-ttu-id="c85d0-110">È importante che la negoziazione OPTIONS sia riuscita (risposta 200OK), consentendo un'ulteriore comunicazione tra SBC e proxy SIP per stabilire le chiamate.</span><span class="sxs-lookup"><span data-stu-id="c85d0-110">It is important for OPTIONS negotiation to be successful (200OK response), allowing for further communication between SBC and SIP Proxy for establishing calls.</span></span> <span data-ttu-id="c85d0-111">Le intestazioni SIP in un messaggio OPTIONS al proxy SIP sono fornite come esempio di seguito:</span><span class="sxs-lookup"><span data-stu-id="c85d0-111">The SIP headers in an OPTIONS messages to SIP Proxy are provided as an example below:</span></span>

| <span data-ttu-id="c85d0-112">Nome parametro</span><span class="sxs-lookup"><span data-stu-id="c85d0-112">Parameter name</span></span> | <span data-ttu-id="c85d0-113">Esempio del valore</span><span class="sxs-lookup"><span data-stu-id="c85d0-113">Example of the value</span></span> | 
| :---------------------  |:---------------------- |
| <span data-ttu-id="c85d0-114">Request-URI</span><span class="sxs-lookup"><span data-stu-id="c85d0-114">Request-URI</span></span> | <span data-ttu-id="c85d0-115">OPZIONI sip:sip.pstnhub.microsoft.com:5061 SIP /2.0</span><span class="sxs-lookup"><span data-stu-id="c85d0-115">OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0</span></span> |
| <span data-ttu-id="c85d0-116">Tramite intestazione</span><span class="sxs-lookup"><span data-stu-id="c85d0-116">Via Header</span></span> | <span data-ttu-id="c85d0-117">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span><span class="sxs-lookup"><span data-stu-id="c85d0-117">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span></span> | 
| <span data-ttu-id="c85d0-118">Max-Forwards intestazione</span><span class="sxs-lookup"><span data-stu-id="c85d0-118">Max-Forwards header</span></span> | <span data-ttu-id="c85d0-119">Max-Forwards:68</span><span class="sxs-lookup"><span data-stu-id="c85d0-119">Max-Forwards:68</span></span> |
| <span data-ttu-id="c85d0-120">Da intestazione</span><span class="sxs-lookup"><span data-stu-id="c85d0-120">From Header</span></span> | <span data-ttu-id="c85d0-121">Da intestazione da: <sip:sbc1.adatum.biz:5058></span><span class="sxs-lookup"><span data-stu-id="c85d0-121">From Header From: <sip:sbc1.adatum.biz:5058></span></span> |
| <span data-ttu-id="c85d0-122">A intestazione</span><span class="sxs-lookup"><span data-stu-id="c85d0-122">To Header</span></span> | <span data-ttu-id="c85d0-123">A: <sip:sip.pstnhub.microsoft.com:5061></span><span class="sxs-lookup"><span data-stu-id="c85d0-123">To: <sip:sip.pstnhub.microsoft.com:5061></span></span> |
| <span data-ttu-id="c85d0-124">Intestazione CSeq</span><span class="sxs-lookup"><span data-stu-id="c85d0-124">CSeq header</span></span> | <span data-ttu-id="c85d0-125">CSeq: 1 INVITA</span><span class="sxs-lookup"><span data-stu-id="c85d0-125">CSeq: 1 INVITE</span></span> | 
| <span data-ttu-id="c85d0-126">Intestazione contatto</span><span class="sxs-lookup"><span data-stu-id="c85d0-126">Contact Header</span></span> | <span data-ttu-id="c85d0-127">Contatto: <sip:sbc1.adatum.biz:50588;transport=tls></span><span class="sxs-lookup"><span data-stu-id="c85d0-127">Contact: <sip:sbc1.adatum.biz:50588;transport=tls></span></span> |

> [!NOTE]
> <span data-ttu-id="c85d0-128">Le intestazioni SIP non contengono userinfo nell'URI SIP in uso.</span><span class="sxs-lookup"><span data-stu-id="c85d0-128">The SIP headers do not contain userinfo in the SIP URI in use.</span></span> <span data-ttu-id="c85d0-129">Come da [RFC 3261, sezione 19.1.1,](https://tools.ietf.org/html/rfc3261#section-19.1.1)la parte userinfo di un URI è facoltativa e può essere assente quando l'host di destinazione non ha una nozione di utenti o quando l'hosst stesso è la risorsa identificata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-129">As per [RFC 3261, section 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1), the userinfo part of a URI is optional and MAY be absent when the destination host does not have a notion of users or when the hosst itself is the resource being identified.</span></span> <span data-ttu-id="c85d0-130">Se il segno @ è presente in un URI SIP, il campo utente NON DEVE essere vuoto.</span><span class="sxs-lookup"><span data-stu-id="c85d0-130">If the @ sign is present in a SIP URI, the user field MUST NOT be empty.</span></span>

<span data-ttu-id="c85d0-131">In una chiamata in arrivo, il proxy SIP deve trovare il tenant a cui è destinata la chiamata e trovare l'utente specifico all'interno del tenant.</span><span class="sxs-lookup"><span data-stu-id="c85d0-131">On an incoming call, the SIP proxy needs to find the tenant to which the call is destined and find the specific user within this tenant.</span></span> <span data-ttu-id="c85d0-132">L'amministratore del tenant potrebbe configurare numeri non DID, ad esempio +1001, in più tenant.</span><span class="sxs-lookup"><span data-stu-id="c85d0-132">The tenant administrator might configure non-DID numbers, for example +1001, in multiple tenants.</span></span> <span data-ttu-id="c85d0-133">Pertanto, è importante trovare il tenant specifico in cui eseguire la ricerca dei numeri perché i numeri non DID potrebbero essere gli stessi in più organizzazioni di Microsoft 365 o Office 365.</span><span class="sxs-lookup"><span data-stu-id="c85d0-133">Therefore, it is important to find the specific tenant on which to perform the number lookup because the non-DID numbers might be the same in multiple Microsoft 365 or Office 365 organizations.</span></span>  

<span data-ttu-id="c85d0-134">Questa sezione descrive come il proxy SIP trova il tenant e l'utente ed esegue l'autenticazione del servizio SBC sulla connessione in ingresso.</span><span class="sxs-lookup"><span data-stu-id="c85d0-134">This section describes how the SIP proxy finds the tenant and the user, and performs authentication of the SBC on the incoming connection.</span></span>

<span data-ttu-id="c85d0-135">Di seguito è riportato un esempio del messaggio Invito SIP in una chiamata in arrivo:</span><span class="sxs-lookup"><span data-stu-id="c85d0-135">The following is an example of the SIP Invite message on an incoming call:</span></span>

| <span data-ttu-id="c85d0-136">Nome parametro</span><span class="sxs-lookup"><span data-stu-id="c85d0-136">Parameter name</span></span> | <span data-ttu-id="c85d0-137">Esempio del valore</span><span class="sxs-lookup"><span data-stu-id="c85d0-137">Example of the value</span></span> | 
| :---------------------  |:---------------------- |
| <span data-ttu-id="c85d0-138">Request-URI</span><span class="sxs-lookup"><span data-stu-id="c85d0-138">Request-URI</span></span> | <span data-ttu-id="c85d0-139">INVITA sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0</span><span class="sxs-lookup"><span data-stu-id="c85d0-139">INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0</span></span> |
| <span data-ttu-id="c85d0-140">Tramite intestazione</span><span class="sxs-lookup"><span data-stu-id="c85d0-140">Via Header</span></span> | <span data-ttu-id="c85d0-141">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span><span class="sxs-lookup"><span data-stu-id="c85d0-141">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span></span> | 
| <span data-ttu-id="c85d0-142">Max-Forwards intestazione</span><span class="sxs-lookup"><span data-stu-id="c85d0-142">Max-Forwards header</span></span> | <span data-ttu-id="c85d0-143">Max-Forwards:68</span><span class="sxs-lookup"><span data-stu-id="c85d0-143">Max-Forwards:68</span></span> |
| <span data-ttu-id="c85d0-144">Da intestazione</span><span class="sxs-lookup"><span data-stu-id="c85d0-144">From Header</span></span> | <span data-ttu-id="c85d0-145">Da intestazione da: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679</span><span class="sxs-lookup"><span data-stu-id="c85d0-145">From Header From: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679</span></span> |
| <span data-ttu-id="c85d0-146">A intestazione</span><span class="sxs-lookup"><span data-stu-id="c85d0-146">To Header</span></span> | <span data-ttu-id="c85d0-147">A: sip:+183338006777@sbc1.adatum.biz</span><span class="sxs-lookup"><span data-stu-id="c85d0-147">To: sip:+183338006777@sbc1.adatum.biz</span></span> | 
| <span data-ttu-id="c85d0-148">Intestazione CSeq</span><span class="sxs-lookup"><span data-stu-id="c85d0-148">CSeq header</span></span> | <span data-ttu-id="c85d0-149">CSeq: 1 INVITA</span><span class="sxs-lookup"><span data-stu-id="c85d0-149">CSeq: 1 INVITE</span></span> | 
| <span data-ttu-id="c85d0-150">Intestazione contatto</span><span class="sxs-lookup"><span data-stu-id="c85d0-150">Contact Header</span></span> | <span data-ttu-id="c85d0-151">Contatto: <sip: 68712781@sbc1.adatum.biz:5058;transport=tls></span><span class="sxs-lookup"><span data-stu-id="c85d0-151">Contact: <sip: 68712781@sbc1.adatum.biz:5058;transport=tls></span></span> | 

<span data-ttu-id="c85d0-152">Alla ricezione dell'invito, il proxy SIP esegue la procedura seguente:</span><span class="sxs-lookup"><span data-stu-id="c85d0-152">On receiving the invite, the SIP proxy performs the following steps:</span></span>

1. <span data-ttu-id="c85d0-153">Controllare il certificato.</span><span class="sxs-lookup"><span data-stu-id="c85d0-153">Check the certificate.</span></span> <span data-ttu-id="c85d0-154">Nella connessione iniziale, il servizio Routing diretto prende il nome FQDN presentato nell'intestazione Contatto e lo trova in corrispondenza del nome comune o del nome alternativo del soggetto del certificato presentato.</span><span class="sxs-lookup"><span data-stu-id="c85d0-154">On the initial connection, the Direct Routing service takes the FQDN name presented in the Contact header and matches it to the Common Name or Subject Alternative name of the presented certificate.</span></span> <span data-ttu-id="c85d0-155">Il nome SBC deve corrispondere a una delle opzioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="c85d0-155">The SBC name must match one of the following options:</span></span>

   - <span data-ttu-id="c85d0-156">Opzione 1.</span><span class="sxs-lookup"><span data-stu-id="c85d0-156">Option 1.</span></span> <span data-ttu-id="c85d0-157">Il nome FQDN completo presentato nell'intestazione Contatto deve corrispondere al nome comune/soggetto alternativo del certificato presentato.</span><span class="sxs-lookup"><span data-stu-id="c85d0-157">The full FQDN name presented in the Contact header must match the Common Name/Subject Alternative name of the presented certificate.</span></span>  

   - <span data-ttu-id="c85d0-158">Opzione 2.</span><span class="sxs-lookup"><span data-stu-id="c85d0-158">Option 2.</span></span> <span data-ttu-id="c85d0-159">La parte relativa al dominio del nome FQDN presentata nell'intestazione Contatto ( ad esempio adatum.biz del nome FQDN sbc1.adatum.biz) deve corrispondere al valore jolly in Nome comune/Nome alternativo oggetto , ad esempio \*.adatum.biz.</span><span class="sxs-lookup"><span data-stu-id="c85d0-159">The domain portion of the FQDN name presented in the Contact header (for example adatum.biz of the FQDN name sbc1.adatum.biz) must match the wildcard value in Common Name/Subject Alternative Name (for example \*.adatum.biz).</span></span>

2. <span data-ttu-id="c85d0-160">Provare a trovare un tenant usando il nome FQDN completo presentato nell'intestazione Contatto.</span><span class="sxs-lookup"><span data-stu-id="c85d0-160">Try to find a tenant using the full FQDN name presented in the Contact header.</span></span>  

   <span data-ttu-id="c85d0-161">Verificare se il nome FQDN dell'intestazione contatto (sbc1.adatum.biz) è registrato come nome DNS in qualsiasi organizzazione di Microsoft 365 o Office 365.</span><span class="sxs-lookup"><span data-stu-id="c85d0-161">Check if the FQDN name from the Contact header (sbc1.adatum.biz) is registered as a DNS name in any Microsoft 365 or Office 365 organization.</span></span> <span data-ttu-id="c85d0-162">Se viene trovato, la ricerca dell'utente viene eseguita nel tenant con l'FQDN SBC registrato come nome di dominio.</span><span class="sxs-lookup"><span data-stu-id="c85d0-162">If found, the lookup of the user is performed in the tenant that has the SBC FQDN registered as a Domain name.</span></span> <span data-ttu-id="c85d0-163">Se non viene trovato, si applica il passaggio 3.</span><span class="sxs-lookup"><span data-stu-id="c85d0-163">If not found, Step 3 applies.</span></span>   

3. <span data-ttu-id="c85d0-164">Il passaggio 3 si applica solo se il passaggio 2 non è riuscito.</span><span class="sxs-lookup"><span data-stu-id="c85d0-164">Step 3 only applies if Step 2 failed.</span></span> 

   <span data-ttu-id="c85d0-165">Rimuovere la parte host dall'FQDN, presentata nell'intestazione contatto (FQDN: sbc12.adatum.biz, dopo aver rimosso la parte host: adatum.biz) e verificare se questo nome è registrato come nome DNS in qualsiasi organizzazione di Microsoft 365 o Office 365.</span><span class="sxs-lookup"><span data-stu-id="c85d0-165">Remove the host portion from the FQDN, presented in the Contact header (FQDN: sbc12.adatum.biz, after removing the host portion: adatum.biz), and check if this name is registered as a DNS name in any Microsoft 365 or Office 365 organization.</span></span> <span data-ttu-id="c85d0-166">Se viene trovato, la ricerca utente viene eseguita in questo tenant.</span><span class="sxs-lookup"><span data-stu-id="c85d0-166">If found, the user lookup is performed in this tenant.</span></span> <span data-ttu-id="c85d0-167">Se non viene trovato, la chiamata non riesce.</span><span class="sxs-lookup"><span data-stu-id="c85d0-167">If not found, the call fails.</span></span>

4. <span data-ttu-id="c85d0-168">Usando il numero di telefono presentato nel Request-URI, eseguire la ricerca inversa del numero all'interno del tenant individuato nel passaggio 2 o 3.</span><span class="sxs-lookup"><span data-stu-id="c85d0-168">Using the phone number presented in the Request-URI, perform the reverse number lookup within the tenant found in Step 2 or 3.</span></span> <span data-ttu-id="c85d0-169">Abbinare il numero di telefono presentato a un URI SIP utente all'interno del tenant trovato nel passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="c85d0-169">Match the presented phone number to a user SIP URI within the tenant found on the previous step.</span></span>

5. <span data-ttu-id="c85d0-170">Applicare le impostazioni del trunk.</span><span class="sxs-lookup"><span data-stu-id="c85d0-170">Apply trunk settings.</span></span> <span data-ttu-id="c85d0-171">Trovare i parametri impostati dall'amministratore del tenant per questo SBC.</span><span class="sxs-lookup"><span data-stu-id="c85d0-171">Find the parameters set by the tenant admin for this SBC.</span></span>

   <span data-ttu-id="c85d0-172">Microsoft non supporta la presenza di un proxy SIP di terze parti o di un server agente utente tra il proxy SIP Microsoft e l'SBC associato, che potrebbe modificare l'URI della richiesta creato dall'SBC associato.</span><span class="sxs-lookup"><span data-stu-id="c85d0-172">Microsoft does not support having a third-party SIP proxy or User Agent Server between the Microsoft SIP proxy and the paired SBC, which might modify the Request URI created by the paired SBC.</span></span>

   <span data-ttu-id="c85d0-173">I requisiti per le due ricerche (passaggi 2 e 3) necessari per lo scenario in cui un SBC è interconnesso con molti tenant (scenario del gestore) sono descritti più avanti in questo articolo.</span><span class="sxs-lookup"><span data-stu-id="c85d0-173">The requirements for the two lookups (steps 2 and 3) needed for the scenario where one SBC is interconnected to many tenants (carrier scenario) are covered later in this article.</span></span>

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a><span data-ttu-id="c85d0-174">Requisiti dettagliati per l'intestazione contact e request-URI</span><span class="sxs-lookup"><span data-stu-id="c85d0-174">Detailed requirements for Contact header and Request-URI</span></span>

#### <a name="contact-header"></a><span data-ttu-id="c85d0-175">Intestazione del contatto</span><span class="sxs-lookup"><span data-stu-id="c85d0-175">Contact header</span></span>

<span data-ttu-id="c85d0-176">Per tutti i messaggi SIP in arrivo (OPZIONI, INVITA) al proxy SIP Microsoft, l'intestazione Contact deve avere l'FQDN SBC associato nel nome host URI come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="c85d0-176">For all incoming SIP messages (OPTIONS, INVITE) to the Microsoft SIP proxy, the Contact header must have the paired SBC FQDN in the URI hostname as follows:</span></span>

<span data-ttu-id="c85d0-177">Sintassi: Contatto: <sip:phone o sip address@FQDN del SBC;transport=tls></span><span class="sxs-lookup"><span data-stu-id="c85d0-177">Syntax: Contact:  <sip:phone or sip address@FQDN of the SBC;transport=tls></span></span> 

<span data-ttu-id="c85d0-178">Come da [RFC 3261, sezione 11.1,](https://tools.ietf.org/html/rfc3261#section-11.1)un campo di intestazione Contatto può essere presente in un messaggio OPZIONI.</span><span class="sxs-lookup"><span data-stu-id="c85d0-178">As per [RFC 3261, section 11.1](https://tools.ietf.org/html/rfc3261#section-11.1), a Contact header field MAY be present in an OPTIONS message.</span></span> <span data-ttu-id="c85d0-179">In Direct Routing l'intestazione del contatto è obbligatoria.</span><span class="sxs-lookup"><span data-stu-id="c85d0-179">In Direct Routing the contact header is required.</span></span> <span data-ttu-id="c85d0-180">Per i messaggi INVITE nel formato precedente, per i messaggi OPTIONS le informazioni utente possono essere rimosse dall'URI SIP e solo l'FQDN inviato nel formato seguente:</span><span class="sxs-lookup"><span data-stu-id="c85d0-180">For INVITE messages in format above, for OPTIONS messages the userinfo can be removed from SIP URI and only FQDN sent in format as follows:</span></span>

<span data-ttu-id="c85d0-181">Sintassi: Contatto: <sip:FQDN del SBC;transport=tls></span><span class="sxs-lookup"><span data-stu-id="c85d0-181">Syntax: Contact:  <sip:FQDN of the SBC;transport=tls></span></span>

<span data-ttu-id="c85d0-182">Questo nome (FQDN) deve essere presente anche nei campi Nome comune o Nome alternativo soggetto del certificato presentato.</span><span class="sxs-lookup"><span data-stu-id="c85d0-182">This name (FQDN) must also be in the Common Name or Subject Alternative name field(s) of the presented certificate.</span></span> <span data-ttu-id="c85d0-183">Microsoft supporta l'uso di valori jolly dei nomi nei campi Nome comune o Nome alternativo soggetto del certificato.</span><span class="sxs-lookup"><span data-stu-id="c85d0-183">Microsoft supports using wildcard values of the name(s) in the Common Name or Subject Alternative Name fields of the certificate.</span></span>   

<span data-ttu-id="c85d0-184">Il supporto per i caratteri jolly è descritto in [RFC 2818, sezione 3.1.](https://tools.ietf.org/html/rfc2818#section-3.1)</span><span class="sxs-lookup"><span data-stu-id="c85d0-184">The support for wildcards is described in [RFC 2818, section 3.1](https://tools.ietf.org/html/rfc2818#section-3.1).</span></span> <span data-ttu-id="c85d0-185">In particolare:</span><span class="sxs-lookup"><span data-stu-id="c85d0-185">Specifically:</span></span>

<span data-ttu-id="c85d0-186">*"I nomi possono contenere il carattere jolly che viene considerato corrispondente a qualsiasi singolo componente del \* nome di dominio o frammento di componente. Ad esempio, .a.com corrisponde foo.a.com ma non bar.foo.a.com. f .com corrisponde foo.com \* \* ma non bar.com".*</span><span class="sxs-lookup"><span data-stu-id="c85d0-186">*"Names may contain the wildcard character \* which is considered to match any single domain name component or component fragment. E.g., \*.a.com matches foo.a.com but not bar.foo.a.com. f\*.com matches foo.com but not bar.com."*</span></span>

<span data-ttu-id="c85d0-187">Se più di un valore nell'intestazione Contatto presentata in un messaggio SIP viene inviato dal servizio SBC, viene usata solo la parte FQDN del primo valore dell'intestazione Contatto.</span><span class="sxs-lookup"><span data-stu-id="c85d0-187">If more than one value in the Contact header presented in a SIP message is sent by the SBC, only the FQDN portion of the first value of the Contact header is used.</span></span>

<span data-ttu-id="c85d0-188">Come regola generale per il routing diretto, è importante usare l'FQDN per popolare l'URI SIP invece di IP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-188">As rule of thumb for Direct Routing, it is important that FQDN is used to populate SIP URI instead of IP.</span></span> <span data-ttu-id="c85d0-189">Messaggio INVITE o OPTIONS in arrivo al proxy SIP con intestazione Contact in cui hostname è rappresentato da IP e non da FQDN, la connessione verrà rifiutata con 403 Accesso negato.</span><span class="sxs-lookup"><span data-stu-id="c85d0-189">An incoming INVITE or OPTIONS message to SIP Proxy with Contact header where hostname is represented by IP and not FQDN, the connection will be refused with 403 Forbidden.</span></span>

#### <a name="request-uri"></a><span data-ttu-id="c85d0-190">Request-URI</span><span class="sxs-lookup"><span data-stu-id="c85d0-190">Request-URI</span></span> 

<span data-ttu-id="c85d0-191">Per tutte le chiamate in arrivo, request-URI viene usato per associare il numero di telefono a un utente.</span><span class="sxs-lookup"><span data-stu-id="c85d0-191">For all incoming calls, the Request-URI is used to match the phone number to a user.</span></span>   

<span data-ttu-id="c85d0-192">Attualmente il numero di telefono deve contenere un segno più (+), come illustrato nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="c85d0-192">Currently The phone number must contain a plus sign (+) as shown in the following example.</span></span> 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```

## <a name="contact-and-record-route-headers-considerations"></a><span data-ttu-id="c85d0-193">Considerazioni sulle intestazioni Record-Route contatti</span><span class="sxs-lookup"><span data-stu-id="c85d0-193">Contact and Record-Route headers considerations</span></span>

<span data-ttu-id="c85d0-194">Il proxy SIP deve calcolare l'FQDN dell'hop successivo per le nuove transazioni client nella finestra di dialogo , ad esempio Bye o Re-Invite, e per rispondere alle opzioni SIP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-194">The SIP proxy needs to calculate the next hop FQDN for new in-dialog client transactions (for example Bye or Re-Invite), and when replying to SIP Options.</span></span> <span data-ttu-id="c85d0-195">Vengono usati contatti o Record-Route contatti.</span><span class="sxs-lookup"><span data-stu-id="c85d0-195">Either Contact or Record-Route are used.</span></span> 

<span data-ttu-id="c85d0-196">In base a [RFC 3261, sezione 8.1.1.8,](https://tools.ietf.org/html/rfc3261#section-8.1.1.8)l'intestazione contatto è obbligatoria in qualsiasi richiesta che può comportare una nuova finestra di dialogo.</span><span class="sxs-lookup"><span data-stu-id="c85d0-196">According to [RFC 3261, section 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8), Contact header is required in any request that can result in a new dialog.</span></span> <span data-ttu-id="c85d0-197">La Record-Route è necessaria solo se un proxy vuole mantenere il percorso delle richieste future in una finestra di dialogo.</span><span class="sxs-lookup"><span data-stu-id="c85d0-197">The Record-Route is only required if a proxy wants to stay on the path of future requests in a dialog.</span></span> <span data-ttu-id="c85d0-198">Se un SBC proxy è in uso con Ottimizzazione multimediale locale per il routing [diretto,](./direct-routing-media-optimization.md)sarà necessario configurare una route di record perché il proxy SBC deve rimanere nella route.</span><span class="sxs-lookup"><span data-stu-id="c85d0-198">If a proxy SBC is in use with [Local Media Optimization for Direct Routing](./direct-routing-media-optimization.md), a record route will need to be configured as the proxy SBC needs to stay in the route.</span></span> 

<span data-ttu-id="c85d0-199">Microsoft consiglia di usare solo l'intestazione Contatto se non viene usato un SBC proxy:</span><span class="sxs-lookup"><span data-stu-id="c85d0-199">Microsoft recommends using only Contact header if a proxy SBC is not used:</span></span>

- <span data-ttu-id="c85d0-200">Per [RFC 3261, sezione 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route viene usato se un proxy vuole mantenere il percorso delle richieste future in una finestra di dialogo, che non è essenziale se non è configurato alcun SBC proxy perché tutto il traffico passa tra il proxy SIP Microsoft e l'SBC associato.</span><span class="sxs-lookup"><span data-stu-id="c85d0-200">Per [RFC 3261, section 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route is used if a proxy wants to stay on the path of future requests in a dialog, which is not essential if no proxy SBC is configured as all traffic goes between the Microsoft SIP proxy and the paired SBC.</span></span> 

- <span data-ttu-id="c85d0-201">Il proxy SIP Microsoft usa solo l'intestazione Contatto (non Record-Route) per determinare l'hop successivo quando si inviano le opzioni di ping in uscita.</span><span class="sxs-lookup"><span data-stu-id="c85d0-201">The Microsoft SIP proxy uses only Contact header (not Record-Route) to determine the next hop when sending outbound ping Options.</span></span> <span data-ttu-id="c85d0-202">La configurazione di un solo parametro (Contatto) invece di due (Contatto e Record-Route) semplifica l'amministrazione se un SBC proxy non è in uso.</span><span class="sxs-lookup"><span data-stu-id="c85d0-202">Configuring only one parameter (Contact) instead of two (Contact and Record-Route) simplifies the administration if a proxy SBC is not in use.</span></span> 

<span data-ttu-id="c85d0-203">Per calcolare l'hop successivo, il proxy SIP usa:</span><span class="sxs-lookup"><span data-stu-id="c85d0-203">To calculate the next hop, the SIP proxy uses:</span></span>

- <span data-ttu-id="c85d0-204">Priorità 1.</span><span class="sxs-lookup"><span data-stu-id="c85d0-204">Priority 1.</span></span> <span data-ttu-id="c85d0-205">Record-Route di primo livello.</span><span class="sxs-lookup"><span data-stu-id="c85d0-205">Top-level Record-Route.</span></span> <span data-ttu-id="c85d0-206">Se il nome di Record-Route di primo livello contiene il nome FQDN, il nome FQDN viene usato per stabilire la connessione in uscita nella finestra di dialogo.</span><span class="sxs-lookup"><span data-stu-id="c85d0-206">If the top-level Record-Route contains the FQDN name, the FQDN name is used to make the outbound in-dialog connection.</span></span>

- <span data-ttu-id="c85d0-207">Priorità 2.</span><span class="sxs-lookup"><span data-stu-id="c85d0-207">Priority 2.</span></span> <span data-ttu-id="c85d0-208">Intestazione del contatto.</span><span class="sxs-lookup"><span data-stu-id="c85d0-208">Contact header.</span></span> <span data-ttu-id="c85d0-209">Se Record-Route non esiste, il proxy SIP cerca il valore dell'intestazione Contatto per stabilire la connessione in uscita.</span><span class="sxs-lookup"><span data-stu-id="c85d0-209">If Record-Route does not exist, the SIP proxy will look up the value of the Contact header to make the outbound connection.</span></span> <span data-ttu-id="c85d0-210">Questa è la configurazione consigliata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-210">(This is the recommended configuration.)</span></span>

<span data-ttu-id="c85d0-211">Se vengono usati sia Contact che Record-Route, l'amministratore SBC deve mantenere identici i valori, causando un sovraccarico amministrativo.</span><span class="sxs-lookup"><span data-stu-id="c85d0-211">If both Contact and Record-Route are used, the SBC administrator must keep their values identical, which causes administrative overhead.</span></span> 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a><span data-ttu-id="c85d0-212">Uso del nome FQDN in Contatto o Record-Route</span><span class="sxs-lookup"><span data-stu-id="c85d0-212">Use of FQDN name in Contact or Record-Route</span></span>

<span data-ttu-id="c85d0-213">L'uso di un indirizzo IP non è supportato in Record-Route o Contatto.</span><span class="sxs-lookup"><span data-stu-id="c85d0-213">Use of an IP address is not supported in either Record-Route or Contact.</span></span> <span data-ttu-id="c85d0-214">L'unica opzione supportata è un FQDN, che deve corrispondere al nome comune o al nome alternativo del soggetto del certificato SBC (sono supportati i valori jolly nel certificato).</span><span class="sxs-lookup"><span data-stu-id="c85d0-214">The only supported option is an FQDN, which must match either the Common Name or Subject Alternative Name of the SBC certificate (wildcard values in the certificate are supported).</span></span>

- <span data-ttu-id="c85d0-215">Se un indirizzo IP viene presentato in Record-route o Contact, la verifica del certificato non riesce e la chiamata non riesce.</span><span class="sxs-lookup"><span data-stu-id="c85d0-215">If an IP address is presented in Record-route or Contact, the certificate check fails and the call fails.</span></span>

- <span data-ttu-id="c85d0-216">Se l'FQDN non corrisponde al valore del nome comune o del nome alternativo del soggetto nel certificato presentato, la chiamata non riesce.</span><span class="sxs-lookup"><span data-stu-id="c85d0-216">If the FQDN does not match the value of the Common or Subject Alternative Name in the presented certificate, the call fails.</span></span> 

## <a name="inbound-call-sip-dialog-description"></a><span data-ttu-id="c85d0-217">Chiamata in ingresso: descrizione della finestra di dialogo SIP</span><span class="sxs-lookup"><span data-stu-id="c85d0-217">Inbound call: SIP dialog description</span></span>

<span data-ttu-id="c85d0-218">La tabella seguente riepiloga le differenze e le analogie del flusso di chiamata tra le modalità non bypass e bypass:</span><span class="sxs-lookup"><span data-stu-id="c85d0-218">The following table below summarizes the call flow differences and similarities between non-bypass and bypass modes:</span></span>

| <span data-ttu-id="c85d0-219">Nome parametro</span><span class="sxs-lookup"><span data-stu-id="c85d0-219">Parameter name</span></span> | <span data-ttu-id="c85d0-220">Modalità non bypass</span><span class="sxs-lookup"><span data-stu-id="c85d0-220">Non-bypass mode</span></span> | <span data-ttu-id="c85d0-221">Modalità bypass</span><span class="sxs-lookup"><span data-stu-id="c85d0-221">Bypass mode</span></span>
| :---------------------  |:---------------------- |:----------------|
| <span data-ttu-id="c85d0-222">Media candidates in 183 and 200 messages coming from</span><span class="sxs-lookup"><span data-stu-id="c85d0-222">Media candidates in 183 and 200 messages coming from</span></span> | <span data-ttu-id="c85d0-223">Processori multimediali</span><span class="sxs-lookup"><span data-stu-id="c85d0-223">Media processors</span></span> | <span data-ttu-id="c85d0-224">Client</span><span class="sxs-lookup"><span data-stu-id="c85d0-224">Clients</span></span> | 
| <span data-ttu-id="c85d0-225">Numero di 183 messaggi che SBC può ricevere</span><span class="sxs-lookup"><span data-stu-id="c85d0-225">Number of 183 messages SBC can receive</span></span> | <span data-ttu-id="c85d0-226">Uno per sessione</span><span class="sxs-lookup"><span data-stu-id="c85d0-226">One per session</span></span> | <span data-ttu-id="c85d0-227">Multiplo</span><span class="sxs-lookup"><span data-stu-id="c85d0-227">Multiple</span></span> | 
| <span data-ttu-id="c85d0-228">La chiamata può essere con risposta provvisoria (183)</span><span class="sxs-lookup"><span data-stu-id="c85d0-228">Call can be with provisional answer (183)</span></span> | <span data-ttu-id="c85d0-229">Sì</span><span class="sxs-lookup"><span data-stu-id="c85d0-229">Yes</span></span> | <span data-ttu-id="c85d0-230">Sì</span><span class="sxs-lookup"><span data-stu-id="c85d0-230">Yes</span></span> |
| <span data-ttu-id="c85d0-231">La chiamata può essere senza risposta provvisoria (183)</span><span class="sxs-lookup"><span data-stu-id="c85d0-231">Call can be without provisional answer (183)</span></span> | <span data-ttu-id="c85d0-232">Sì</span><span class="sxs-lookup"><span data-stu-id="c85d0-232">Yes</span></span> | <span data-ttu-id="c85d0-233">Sì</span><span class="sxs-lookup"><span data-stu-id="c85d0-233">Yes</span></span> |

###  <a name="non-media-bypass-flow"></a><span data-ttu-id="c85d0-234">Flusso di bypass non multimediale</span><span class="sxs-lookup"><span data-stu-id="c85d0-234">Non-media bypass flow</span></span>

<span data-ttu-id="c85d0-235">Un utente di Teams potrebbe avere più endpoint contemporaneamente.</span><span class="sxs-lookup"><span data-stu-id="c85d0-235">A Teams user might have multiple endpoints at the same time.</span></span> <span data-ttu-id="c85d0-236">Ad esempio, il client Teams per Windows, il client Teams per iPhone e Teams Phone (client Android di Teams).</span><span class="sxs-lookup"><span data-stu-id="c85d0-236">For example, Teams for Windows client, Teams for iPhone client, and Teams Phone (Teams Android client).</span></span> <span data-ttu-id="c85d0-237">Ogni endpoint potrebbe segnalare una pausa HTTP nel modo seguente:</span><span class="sxs-lookup"><span data-stu-id="c85d0-237">Each endpoint might signal an HTTP rest as follows:</span></span>

-   <span data-ttu-id="c85d0-238">Stato della chiamata: convertito dal proxy SIP nel messaggio SIP 180.</span><span class="sxs-lookup"><span data-stu-id="c85d0-238">Call progress – converted by the SIP proxy to the SIP message 180.</span></span> <span data-ttu-id="c85d0-239">Quando si riceve il messaggio 180, il servizio SBC deve generare squilli locali.</span><span class="sxs-lookup"><span data-stu-id="c85d0-239">On receiving message 180, the SBC must generate local ringing.</span></span>

-   <span data-ttu-id="c85d0-240">Risposta multimediale: convertita dal proxy SIP nel messaggio 183 con i candidati multimediali nel protocollo SDP (Session Description Protocol).</span><span class="sxs-lookup"><span data-stu-id="c85d0-240">Media answer – converted by the SIP proxy to message 183 with media candidates in Session Description Protocol (SDP).</span></span> <span data-ttu-id="c85d0-241">Alla ricezione del messaggio 183, SBC prevede di connettersi ai candidati multimediali ricevuti nel messaggio SDP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-241">On receiving message 183, the SBC expects to connect to the media candidates received in the SDP message.</span></span> 

    > [!NOTE]
    > <span data-ttu-id="c85d0-242">In alcuni casi la risposta media potrebbe non essere generata e il punto finale potrebbe rispondere con il messaggio "Chiamata accettata".</span><span class="sxs-lookup"><span data-stu-id="c85d0-242">In some cases the Media answer might not be generated, and the end point might answer with “Call Accepted” message.</span></span>

-   <span data-ttu-id="c85d0-243">Chiamata accettata: convertita dal proxy SIP nel messaggio SIP 200 con SDP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-243">Call accepted – converted by the SIP proxy to SIP message 200 with SDP.</span></span> <span data-ttu-id="c85d0-244">Alla ricezione del messaggio 200, è previsto che SBC invii e riceva elementi multimediali da e verso i candidati SDP forniti.</span><span class="sxs-lookup"><span data-stu-id="c85d0-244">On receiving message 200, the SBC is expected to send and receive media to and from the provided SDP candidates.</span></span>

    > [!NOTE]
    > <span data-ttu-id="c85d0-245">Il routing diretto non supporta l'invito all'offerta ritardata (invito senza SDP).</span><span class="sxs-lookup"><span data-stu-id="c85d0-245">Direct Routing does not support Delayed Offer Invite (Invite without SDP).</span></span>

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a><span data-ttu-id="c85d0-246">Squillo di più endpoint con risposta provvisoria</span><span class="sxs-lookup"><span data-stu-id="c85d0-246">Multiple endpoints ringing with provisional answer</span></span>

1.  <span data-ttu-id="c85d0-247">Alla ricezione del primo invito da SBC, il proxy SIP invia il messaggio "SIP SIP/2.0 100 Tentativo" e notifica a tutti gli endpoint dell'utente finale la chiamata in arrivo.</span><span class="sxs-lookup"><span data-stu-id="c85d0-247">On receiving the first Invite from the SBC, the SIP proxy sends the message "SIP SIP/2.0 100 Trying" and notifies all end user endpoints about the incoming call.</span></span> 

2.  <span data-ttu-id="c85d0-248">Al momento della notifica, ogni endpoint inizierà a squillare e a inviare messaggi "Stato chiamata" al proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-248">Upon notification, each endpoint will start ringing and sending "Call progress” messages to the SIP proxy.</span></span> <span data-ttu-id="c85d0-249">Poiché un utente di Teams può avere più punti finali, il proxy SIP potrebbe ricevere più messaggi di stato delle chiamate.</span><span class="sxs-lookup"><span data-stu-id="c85d0-249">Because a Teams user can have multiple end points, the SIP proxy might receive multiple Call Progress messages.</span></span>

3.  <span data-ttu-id="c85d0-250">Per ogni messaggio di stato della chiamata ricevuto dai client, il proxy SIP converte il messaggio Stato chiamata nel messaggio SIP "SIP SIP/2.0 180 Trying".</span><span class="sxs-lookup"><span data-stu-id="c85d0-250">For every Call Progress message received from the clients, the SIP proxy converts the Call Progress message to the SIP message "SIP SIP/2.0 180 Trying".</span></span> <span data-ttu-id="c85d0-251">L'intervallo per l'invio di tali messaggi è definito dall'intervallo dei messaggi ricevuti dal Controllore chiamate.</span><span class="sxs-lookup"><span data-stu-id="c85d0-251">The interval for sending such messages is defined by the interval of the receiving messages from the Call Controller.</span></span> <span data-ttu-id="c85d0-252">Nel diagramma seguente sono presenti due 180 messaggi generati dal proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-252">In the following diagram, there are two 180 messages generated by the SIP proxy.</span></span> <span data-ttu-id="c85d0-253">Questi messaggi provengono dai due endpoint di Teams dell'utente.</span><span class="sxs-lookup"><span data-stu-id="c85d0-253">These messages come from the two Teams endpoints of the user.</span></span> <span data-ttu-id="c85d0-254">Ogni client ha un ID tag univoco.</span><span class="sxs-lookup"><span data-stu-id="c85d0-254">The clients each have a unique Tag ID.</span></span>  <span data-ttu-id="c85d0-255">Ogni messaggio proveniente da un endpoint diverso sarà una sessione separata (il parametro "tag" nel campo "A" sarà diverso).</span><span class="sxs-lookup"><span data-stu-id="c85d0-255">Every message coming from a different endpoint will be a separate session (the parameter “tag” in the “To” field will be different).</span></span> <span data-ttu-id="c85d0-256">Tuttavia, un endpoint potrebbe non generare immediatamente il messaggio 180 e inviare immediatamente il messaggio 183, come illustrato nel diagramma seguente.</span><span class="sxs-lookup"><span data-stu-id="c85d0-256">But an endpoint might not generate message 180 and send message 183 right away as shown in the following diagram.</span></span>

4.  <span data-ttu-id="c85d0-257">Quando un endpoint genera un messaggio Media Answer con gli indirizzi IP dei candidati per i supporti multimediali dell'endpoint, il proxy SIP converte il messaggio ricevuto in un messaggio "Stato sessione SIP 183" con il SDP del client sostituito dal provider di servizi multimediali dal processore multimediale.</span><span class="sxs-lookup"><span data-stu-id="c85d0-257">Once an endpoint generates a Media Answer message with the IP addresses of endpoint’s media candidates, the SIP proxy converts the message received to a "SIP 183 Session Progress" message with the SDP from the client replaced by the SDP from the Media Processor.</span></span> <span data-ttu-id="c85d0-258">Nel diagramma seguente, l'endpoint da Fork 2 ha risposto alla chiamata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-258">In the following diagram, the endpoint from Fork 2 answered the call.</span></span> <span data-ttu-id="c85d0-259">Se il trunk non viene ignorato, il messaggio SIP 183 viene generato una sola volta (Ring Bot o Client End Point).</span><span class="sxs-lookup"><span data-stu-id="c85d0-259">If the trunk is non-bypassed, the 183 SIP message is generated only once (either Ring Bot or Client End Point).</span></span> <span data-ttu-id="c85d0-260">Il 183 potrebbe essere una forchetta esistente o crearne una nuova.</span><span class="sxs-lookup"><span data-stu-id="c85d0-260">The 183 might come on an existing fork or start a new one.</span></span>

5.  <span data-ttu-id="c85d0-261">Viene inviato un messaggio di accettazione chiamata con i candidati finali dell'endpoint che hanno accettato la chiamata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-261">A Call Acceptance message is sent with the final candidates of the endpoint that accepted the call.</span></span> <span data-ttu-id="c85d0-262">Il messaggio accettazione chiamata viene convertito in messaggio SIP 200.</span><span class="sxs-lookup"><span data-stu-id="c85d0-262">The Call Acceptance message is converted to SIP message 200.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="c85d0-263">![Diagramma che mostra più endpoint che squillano con risposta provvisoria](media/direct-routing-protocols-1.png)</span><span class="sxs-lookup"><span data-stu-id="c85d0-263">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-1.png)</span></span>

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a><span data-ttu-id="c85d0-264">Squillo di più endpoint senza risposta provvisoria</span><span class="sxs-lookup"><span data-stu-id="c85d0-264">Multiple endpoints ringing without provisional answer</span></span>

1.  <span data-ttu-id="c85d0-265">Alla ricezione del primo invito da SBC, il proxy SIP invia il messaggio "SIP SIP/2.0 100 Tentativo" e notifica a tutti gli endpoint dell'utente finale la chiamata in arrivo.</span><span class="sxs-lookup"><span data-stu-id="c85d0-265">On receiving the first Invite from the SBC, the SIP proxy sends the message "SIP SIP/2.0 100 Trying" and notifies all end user endpoints about the incoming call.</span></span> 

2.  <span data-ttu-id="c85d0-266">Al momento della notifica, ogni endpoint inizierà a squillare e a inviare il messaggio "Stato chiamata" al proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-266">Upon notification, each endpoint will start ringing and sending the message "Call progress” to the SIP proxy.</span></span> <span data-ttu-id="c85d0-267">Poiché un utente di Teams può avere più punti finali, il proxy SIP potrebbe ricevere più messaggi di stato delle chiamate.</span><span class="sxs-lookup"><span data-stu-id="c85d0-267">Because a Teams user can have multiple end points, the SIP proxy might receive multiple Call Progress messages.</span></span>

3.  <span data-ttu-id="c85d0-268">Per ogni messaggio di stato della chiamata ricevuto dai client, il proxy SIP converte il messaggio Stato chiamata nel messaggio SIP "SIP SIP/2.0 180 Trying".</span><span class="sxs-lookup"><span data-stu-id="c85d0-268">For every Call Progress message received from the clients, the SIP proxy converts the Call Progress message to the SIP message "SIP SIP/2.0 180 Trying".</span></span>  <span data-ttu-id="c85d0-269">L'intervallo per l'invio dei messaggi è definito dall'intervallo di ricezione dei messaggi dal Controllore chiamate.</span><span class="sxs-lookup"><span data-stu-id="c85d0-269">The interval for sending the messages is defined by the interval of receiving the messages from the Call Controller.</span></span> <span data-ttu-id="c85d0-270">Nell'immagine seguente sono presenti due 180 messaggi generati dal proxy SIP, il che significa che l'utente ha effettuato l'accesso a tre client di Teams e ogni client invia lo stato di avanzamento della chiamata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-270">On the picture below there are two 180 messages generated by the SIP proxy, meaning that user logged into three Teams clients and each client send the call progress.</span></span> <span data-ttu-id="c85d0-271">Ogni messaggio sarà una sessione separata (il parametro "tag" nel campo "A" è diverso)</span><span class="sxs-lookup"><span data-stu-id="c85d0-271">Every message will be a separate session (parameter “tag” in “To” field is different)</span></span>

4.  <span data-ttu-id="c85d0-272">Viene inviato un messaggio di accettazione chiamata con i candidati finali dell'endpoint che hanno accettato la chiamata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-272">A Call Acceptance message is sent with the final candidates of the endpoint that accepted the call.</span></span> <span data-ttu-id="c85d0-273">Il messaggio accettazione chiamata viene convertito in messaggio SIP 200.</span><span class="sxs-lookup"><span data-stu-id="c85d0-273">The Call Acceptance message is converted to SIP message 200.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="c85d0-274">![Diagramma che mostra più endpoint squillare senza risposta provvisoria](media/direct-routing-protocols-2.png)</span><span class="sxs-lookup"><span data-stu-id="c85d0-274">![Diagram showing multiple endpoints ringing without provisional answer](media/direct-routing-protocols-2.png)</span></span>

### <a name="media-bypass-flow"></a><span data-ttu-id="c85d0-275">Flusso di bypass multimediale</span><span class="sxs-lookup"><span data-stu-id="c85d0-275">Media bypass flow</span></span>

<span data-ttu-id="c85d0-276">Gli stessi messaggi (100 Prova, 180, 183) vengono usati nello scenario di bypass multimediale.</span><span class="sxs-lookup"><span data-stu-id="c85d0-276">The same messages (100 Trying, 180, 183) are used in the media bypass scenario.</span></span> 

<span data-ttu-id="c85d0-277">Lo schema seguente mostra un esempio del flusso delle chiamate bypass.</span><span class="sxs-lookup"><span data-stu-id="c85d0-277">The schema below shows an example of the bypass call flow.</span></span> 

> [!NOTE]
> <span data-ttu-id="c85d0-278">I candidati ai contenuti multimediali possono provengono da endpoint diversi.</span><span class="sxs-lookup"><span data-stu-id="c85d0-278">The media candidates can come from different endpoints.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="c85d0-279">![Diagramma che mostra più endpoint che squillano con risposta provvisoria](media/direct-routing-protocols-3.png)</span><span class="sxs-lookup"><span data-stu-id="c85d0-279">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-3.png)</span></span>

## <a name="replaces-option"></a><span data-ttu-id="c85d0-280">Opzione Sostituisci</span><span class="sxs-lookup"><span data-stu-id="c85d0-280">Replaces option</span></span>

<span data-ttu-id="c85d0-281">L'SBC deve supportare l'invito con le sostituzioni.</span><span class="sxs-lookup"><span data-stu-id="c85d0-281">The SBC must support Invite with Replaces.</span></span>

## <a name="size-of-sdp-considerations"></a><span data-ttu-id="c85d0-282">Considerazioni sulle dimensioni di SDP</span><span class="sxs-lookup"><span data-stu-id="c85d0-282">Size of SDP considerations</span></span>

<span data-ttu-id="c85d0-283">L'interfaccia di routing diretto potrebbe inviare un messaggio SIP superiore a 1.500 byte.</span><span class="sxs-lookup"><span data-stu-id="c85d0-283">The Direct Routing interface might send a SIP message exceeding 1,500 bytes.</span></span>  <span data-ttu-id="c85d0-284">Le dimensioni di SDP causano principalmente questo problema.</span><span class="sxs-lookup"><span data-stu-id="c85d0-284">The size of SDP primarily causes this.</span></span> <span data-ttu-id="c85d0-285">Tuttavia, se dietro il trunk SBC è presente un trunk UDP, il messaggio potrebbe essere rifiutato se viene inoltrato dal proxy SIP Microsoft al trunk non modificato.</span><span class="sxs-lookup"><span data-stu-id="c85d0-285">However, if there is a UDP trunk behind the SBC, it might reject the message if it is forwarded from the Microsoft SIP proxy to the trunk unmodified.</span></span> <span data-ttu-id="c85d0-286">Microsoft consiglia di rimuovere alcuni valori in SDP nel database SBC quando si invia il messaggio ai trunk UDP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-286">Microsoft recommends stripping some values in SDP on the SBC when sending the message to the UDP trunks.</span></span> <span data-ttu-id="c85d0-287">Ad esempio, i candidati ICE o i codec inutilizzati possono essere rimossi.</span><span class="sxs-lookup"><span data-stu-id="c85d0-287">For example, the ICE candidates or unused codecs can be removed.</span></span>

## <a name="call-transfer"></a><span data-ttu-id="c85d0-288">Trasferimento di chiamata</span><span class="sxs-lookup"><span data-stu-id="c85d0-288">Call transfer</span></span>

<span data-ttu-id="c85d0-289">Routing diretto supporta due metodi per il trasferimento delle chiamate:</span><span class="sxs-lookup"><span data-stu-id="c85d0-289">Direct Routing supports two methods for call transfer:</span></span>

- <span data-ttu-id="c85d0-290">Opzione 1.</span><span class="sxs-lookup"><span data-stu-id="c85d0-290">Option 1.</span></span> <span data-ttu-id="c85d0-291">Processi proxy SIP Fare riferimento al client in locale e funge da arbitro come descritto nella sezione 7.1 di RFC 3892.</span><span class="sxs-lookup"><span data-stu-id="c85d0-291">SIP proxy processes Refer from the client locally and acts as a Referee as described in section 7.1 of RFC 3892.</span></span>

  <span data-ttu-id="c85d0-292">Con questa opzione, il proxy SIP termina il trasferimento e aggiunge un nuovo invito.</span><span class="sxs-lookup"><span data-stu-id="c85d0-292">With this option, the SIP proxy terminates the transfer and adds a new Invite.</span></span> 


- <span data-ttu-id="c85d0-293">Opzione 2.</span><span class="sxs-lookup"><span data-stu-id="c85d0-293">Option 2.</span></span> <span data-ttu-id="c85d0-294">Il proxy SIP invia il riferimento all'SBC e funge da transferor come descritto nella sezione 6 di RFC 5589.</span><span class="sxs-lookup"><span data-stu-id="c85d0-294">SIP proxy sends the Refer to the SBC and acts as a Transferor as describing in Section 6 of RFC 5589.</span></span>

  <span data-ttu-id="c85d0-295">Con questa opzione, il proxy SIP invia un riferimento a SBC e prevede che SBC gestirà completamente il trasferimento.</span><span class="sxs-lookup"><span data-stu-id="c85d0-295">With this option, the SIP proxy sends a Refer to the SBC and expects the SBC to handle the Transfer fully.</span></span>

<span data-ttu-id="c85d0-296">Il proxy SIP seleziona il metodo in base alle funzionalità segnalate da SBC.</span><span class="sxs-lookup"><span data-stu-id="c85d0-296">The SIP proxy selects the method based on the capabilities reported by the SBC.</span></span> <span data-ttu-id="c85d0-297">Se SBC indica che supporta il metodo "Refer", il proxy SIP userà l'opzione 2 per i trasferimenti di chiamata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-297">If the SBC indicates that it supports the method “Refer”, the SIP proxy will use Option 2 for call transfers.</span></span>

<span data-ttu-id="c85d0-298">Di seguito è riportato un esempio di SBC che invia il messaggio che indica che il metodo Refer è supportato:</span><span class="sxs-lookup"><span data-stu-id="c85d0-298">The following is an example of an SBC sending the message that the Refer method is supported:</span></span>

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

<span data-ttu-id="c85d0-299">Se L'SBC non indica che Fare riferimento come metodo supportato, il routing diretto userà l'opzione 1 (il proxy SIP funge da arbitro).</span><span class="sxs-lookup"><span data-stu-id="c85d0-299">If the SBC doesn’t indicate that Refer as a supported method, Direct Routing will use Option 1 (SIP proxy acts as a Referee) .</span></span> <span data-ttu-id="c85d0-300">SBC deve anche segnalare che supporta il metodo Notify:</span><span class="sxs-lookup"><span data-stu-id="c85d0-300">The SBC  must also signal that it supports the Notify method:</span></span>

<span data-ttu-id="c85d0-301">Esempio di SBC che indica che il metodo Refer non è supportato:</span><span class="sxs-lookup"><span data-stu-id="c85d0-301">Example of SBC indicating that Refer method is not supported:</span></span>

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a><span data-ttu-id="c85d0-302">Processi proxy SIP Fare riferimento dal client in locale e funge da arbitro</span><span class="sxs-lookup"><span data-stu-id="c85d0-302">SIP proxy processes Refer from the client locally and acts as a Referee</span></span>

<span data-ttu-id="c85d0-303">Se SBC indica che il metodo Refer non è supportato, il proxy SIP funge da arbitro.</span><span class="sxs-lookup"><span data-stu-id="c85d0-303">If the SBC indicated that the Refer method is not supported, the SIP proxy acts as a Referee.</span></span> 

<span data-ttu-id="c85d0-304">La richiesta referenziata del client verrà terminata nel proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-304">The Refer request that comes from the client will be terminated on the SIP proxy.</span></span> <span data-ttu-id="c85d0-305">La richiesta referenziare del cliente viene visualizzata come "Trasferimento di chiamata a Davide" nel diagramma seguente.</span><span class="sxs-lookup"><span data-stu-id="c85d0-305">(The Refer request from the client is shown as “Call transfer to Dave” in the following diagram.</span></span>  <span data-ttu-id="c85d0-306">Per altre informazioni, vedere la sezione 7.1 di [RFC 3892.](https://www.ietf.org/rfc/rfc3892.txt)</span><span class="sxs-lookup"><span data-stu-id="c85d0-306">For more information, see section 7.1 of [RFC 3892](https://www.ietf.org/rfc/rfc3892.txt).</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="c85d0-307">![Diagramma che mostra più endpoint che squillano con risposta provvisoria](media/direct-routing-protocols-4.png)</span><span class="sxs-lookup"><span data-stu-id="c85d0-307">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-4.png)</span></span>

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a><span data-ttu-id="c85d0-308">Il proxy SIP invia l'indirizzo Refer to the SBC e funge da transferor</span><span class="sxs-lookup"><span data-stu-id="c85d0-308">SIP proxy send the Refer to the SBC and acts as a Transferor</span></span>

<span data-ttu-id="c85d0-309">Questo è il metodo preferito per i trasferimenti di chiamata ed è obbligatorio per i dispositivi che cercano la certificazione di bypass multimediale.</span><span class="sxs-lookup"><span data-stu-id="c85d0-309">This is the preferred method for call transfers, and it is mandatory for devices seeking media bypass certification.</span></span> <span data-ttu-id="c85d0-310">Trasferimento di chiamata senza che SBC sia in grado di gestire Refer non è supportato nella modalità di bypass multimediale.</span><span class="sxs-lookup"><span data-stu-id="c85d0-310">Call Transfer without the SBC being able to handle Refer is not supported in media bypass mode.</span></span> 

<span data-ttu-id="c85d0-311">Lo standard è illustrato nella sezione 6 di RFC 5589.</span><span class="sxs-lookup"><span data-stu-id="c85d0-311">The standard is explained in Section 6 of RFC 5589.</span></span> <span data-ttu-id="c85d0-312">Le RFC correlate sono:</span><span class="sxs-lookup"><span data-stu-id="c85d0-312">The related RFCs are:</span></span>

- [<span data-ttu-id="c85d0-313">Session Initiation Protocol (SIP) Call Control - Transfer</span><span class="sxs-lookup"><span data-stu-id="c85d0-313">Session Initiation Protocol (SIP) Call Control - Transfer</span></span>](https://tools.ietf.org/html/rfc5589)

- [<span data-ttu-id="c85d0-314">Intestazione SIP (Session Initiation Protocol) "Sostituisce"</span><span class="sxs-lookup"><span data-stu-id="c85d0-314">Session Initiation Protocol (SIP) "Replaces" Header</span></span>](https://tools.ietf.org/html/rfc3891)

- [<span data-ttu-id="c85d0-315">Meccanismo sip (Session Initiation Protocol) "Referred-By"</span><span class="sxs-lookup"><span data-stu-id="c85d0-315">Session Initiation Protocol (SIP) "Referred-By" mechanism</span></span>](https://tools.ietf.org/html/rfc3892)

<span data-ttu-id="c85d0-316">Questa opzione presuppone che il proxy SIP agisca da transferor e invii un messaggio Di riferimento a SBC.</span><span class="sxs-lookup"><span data-stu-id="c85d0-316">This option assumes that the SIP proxy acts as a Transferor and sends a Refer message to the SBC.</span></span> <span data-ttu-id="c85d0-317">L'SBC funge da cessione e gestisce il riferimento per generare una nuova offerta per il trasferimento.</span><span class="sxs-lookup"><span data-stu-id="c85d0-317">The SBC acts as a Transferee and handles the Refer to generate a new offer for transfer.</span></span> <span data-ttu-id="c85d0-318">Esistono due casi possibili:</span><span class="sxs-lookup"><span data-stu-id="c85d0-318">There are two possible cases:</span></span>

- <span data-ttu-id="c85d0-319">La chiamata viene trasferita a un partecipante PSTN esterno.</span><span class="sxs-lookup"><span data-stu-id="c85d0-319">The call is transferred to an external PSTN participant.</span></span> 
- <span data-ttu-id="c85d0-320">La chiamata viene trasferita da un utente di Teams a un altro utente di Teams nello stesso tenant tramite SBC.</span><span class="sxs-lookup"><span data-stu-id="c85d0-320">The call is transferred from one Teams user to another Teams user in the same tenant via the SBC.</span></span> 

<span data-ttu-id="c85d0-321">Se la chiamata viene trasferita da un utente di Teams a un altro tramite SBC, il SBC dovrebbe emettere un nuovo invito (avviare una nuova finestra di dialogo) per l'obiettivo di trasferimento (l'utente di Teams) usando le informazioni ricevute nel messaggio Di riferimento.</span><span class="sxs-lookup"><span data-stu-id="c85d0-321">If the call is transferred from one Teams user to another via the SBC, the SBC is expected to issue a new invite (start a new dialog) for the transfer target (the Teams user) using the information received in the Refer message.</span></span> 

<span data-ttu-id="c85d0-322">Per popolare i campi A/Trasferimento per la transazione della richiesta internamente, il proxy SIP deve comunicare queste informazioni all'interno delle intestazioni REFER-TO/REFERRED-BY.</span><span class="sxs-lookup"><span data-stu-id="c85d0-322">To populate the To/Transferor fields for the transaction of the request internally, the SIP proxy needs to convey this information  inside the REFER-TO/REFERRED-BY headers.</span></span> 

<span data-ttu-id="c85d0-323">Il proxy SIP formerà refer-TO come URI SIP costituito da un FQDN del proxy SIP nel nome host e da una delle opzioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="c85d0-323">The SIP proxy will form the REFER-TO as a SIP URI comprised of a SIP proxy FQDN in the hostname and either one of the following:</span></span>

- <span data-ttu-id="c85d0-324">Un numero di telefono E.164 nella parte username dell'URI nel caso in cui l'obiettivo di trasferimento sia un numero di telefono o</span><span class="sxs-lookup"><span data-stu-id="c85d0-324">An E.164 phone number in the username part of the URI in case the transfer target is a phone number, or</span></span>

- <span data-ttu-id="c85d0-325">Parametri x-m e x-t che codificano rispettivamente la RMI di destinazione del trasferimento completo e l'ID tenant</span><span class="sxs-lookup"><span data-stu-id="c85d0-325">x-m and x-t parameters encoding the full transfer target MRI and tenant ID respectively</span></span> 

<span data-ttu-id="c85d0-326">L'intestazione REFERRED-BY è un URI SIP con MRI del trasferimento codificato, l'ID tenant del trasferimento e altri parametri del contesto di trasferimento, come illustrato nella tabella seguente:</span><span class="sxs-lookup"><span data-stu-id="c85d0-326">The REFERRED-BY header is a SIP URI with transferor MRI encoded in it as well as transferor tenant ID and other transfer context parameters as shown in the following table:</span></span>

| <span data-ttu-id="c85d0-327">Parametro</span><span class="sxs-lookup"><span data-stu-id="c85d0-327">Parameter</span></span> | <span data-ttu-id="c85d0-328">Valore</span><span class="sxs-lookup"><span data-stu-id="c85d0-328">Value</span></span> | <span data-ttu-id="c85d0-329">Descrizione</span><span class="sxs-lookup"><span data-stu-id="c85d0-329">Description</span></span> |  
|:---------------------  |:---------------------- |:---------------------- |
| <span data-ttu-id="c85d0-330">x-m</span><span class="sxs-lookup"><span data-stu-id="c85d0-330">x-m</span></span> | <span data-ttu-id="c85d0-331">MRI</span><span class="sxs-lookup"><span data-stu-id="c85d0-331">MRI</span></span> | <span data-ttu-id="c85d0-332">MRI completo dell'obiettivo di trasferimento/trasferimento come popolato da CC</span><span class="sxs-lookup"><span data-stu-id="c85d0-332">Full MRI of transferor/transfer target as populated by CC</span></span> |
| <span data-ttu-id="c85d0-333">x-t</span><span class="sxs-lookup"><span data-stu-id="c85d0-333">x-t</span></span> | <span data-ttu-id="c85d0-334">ID tenant</span><span class="sxs-lookup"><span data-stu-id="c85d0-334">Tenant ID</span></span> | <span data-ttu-id="c85d0-335">x-t ID tenant ID tenant facoltativo popolato da CC</span><span class="sxs-lookup"><span data-stu-id="c85d0-335">x-t Tenant ID Optional Tenant ID as populated by CC</span></span> |
| <span data-ttu-id="c85d0-336">x-ti</span><span class="sxs-lookup"><span data-stu-id="c85d0-336">x-ti</span></span> | <span data-ttu-id="c85d0-337">ID di correlazione del trasferimentore</span><span class="sxs-lookup"><span data-stu-id="c85d0-337">Transferor Correlation Id</span></span> | <span data-ttu-id="c85d0-338">ID di correlazione della chiamata al trasferimento</span><span class="sxs-lookup"><span data-stu-id="c85d0-338">Correlation ID of the call to the transferor</span></span> |
| <span data-ttu-id="c85d0-339">x-tt</span><span class="sxs-lookup"><span data-stu-id="c85d0-339">x-tt</span></span> | <span data-ttu-id="c85d0-340">TRASFERIRE l'URI della chiamata di destinazione</span><span class="sxs-lookup"><span data-stu-id="c85d0-340">Transfer target call URI</span></span> | <span data-ttu-id="c85d0-341">URI di sostituzione della chiamata codificato</span><span class="sxs-lookup"><span data-stu-id="c85d0-341">Encoded call replacement URI</span></span> |

<span data-ttu-id="c85d0-342">In questo caso, le dimensioni dell'intestazione di riferimento possono essere fino a 400 simboli.</span><span class="sxs-lookup"><span data-stu-id="c85d0-342">The size of the Refer Header can be up to 400 symbols in this case.</span></span> <span data-ttu-id="c85d0-343">SBC deve supportare la gestione dei messaggi Di riferimento con dimensioni fino a 400 simboli.</span><span class="sxs-lookup"><span data-stu-id="c85d0-343">The SBC must support handling Refer messages with size up to 400 symbols.</span></span>

> [!div class="mx-imgBorder"]
> <span data-ttu-id="c85d0-344">![Diagramma che mostra più endpoint che squillano con risposta provvisoria](media/direct-routing-protocols-5.png)</span><span class="sxs-lookup"><span data-stu-id="c85d0-344">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-5.png)</span></span>

## <a name="session-timer"></a><span data-ttu-id="c85d0-345">Timer di sessione</span><span class="sxs-lookup"><span data-stu-id="c85d0-345">Session timer</span></span>

<span data-ttu-id="c85d0-346">Il proxy SIP supporta (sempre) il timer di sessione per le chiamate non bypass, ma non lo offre per le chiamate bypass.</span><span class="sxs-lookup"><span data-stu-id="c85d0-346">The SIP proxy supports (always offers) the Session Timer on non-bypass calls but does not offer it on bypass calls.</span></span> <span data-ttu-id="c85d0-347">L'uso del timer di sessione da parte di SBC non è obbligatorio.</span><span class="sxs-lookup"><span data-stu-id="c85d0-347">Use of the Session Timer by the SBC is not mandatory.</span></span>

##  <a name="use-of-request-uri-parameter-userphone"></a><span data-ttu-id="c85d0-348">Uso del parametro Request-URI user=phone</span><span class="sxs-lookup"><span data-stu-id="c85d0-348">Use of Request-URI parameter user=phone</span></span>

<span data-ttu-id="c85d0-349">Il proxy SIP analizza request-URI e, se il parametro user=phone è presente, il servizio gestirà l'URI della richiesta come numero di telefono, abbinando il numero a un utente.</span><span class="sxs-lookup"><span data-stu-id="c85d0-349">The SIP proxy analyses the Request-URI and if the parameter user=phone is present, the service will handle the Request-URI as a phone number, matching the number to a user.</span></span> <span data-ttu-id="c85d0-350">Se parametro non è presente, il proxy SIP applica l'euristica per determinare il tipo di utente Request-URI (numero di telefono o indirizzo SIP).</span><span class="sxs-lookup"><span data-stu-id="c85d0-350">If parameter is not present the SIP proxy applies heuristics to determine  the Request-URI user type (phone number or a SIP address).</span></span>

<span data-ttu-id="c85d0-351">Microsoft consiglia di applicare sempre il parametro user=phone per semplificare il processo di configurazione della chiamata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-351">Microsoft recommends always applying the user=phone parameter to simplify the call setup process.</span></span>

## <a name="history-info-header"></a><span data-ttu-id="c85d0-352">History-Info intestazione</span><span class="sxs-lookup"><span data-stu-id="c85d0-352">History-Info header</span></span>

<span data-ttu-id="c85d0-353">L'intestazione History-Info viene usata per il retargeting delle richieste SIP e "fornisce un meccanismo standard per l'acquisizione delle informazioni della cronologia delle richieste per consentire un'ampia gamma di servizi per le reti e gli utenti finali".</span><span class="sxs-lookup"><span data-stu-id="c85d0-353">The History-Info header is used for retargeting SIP requests and “provide(s) a standard mechanism for capturing the request history information to enable a wide variety of services for networks and end-users.”</span></span> <span data-ttu-id="c85d0-354">Per altre informazioni, vedere [RFC 4244 – Sezione 1.1.](http://www.ietf.org/rfc/rfc4244.txt)</span><span class="sxs-lookup"><span data-stu-id="c85d0-354">For more information, see [RFC 4244 – Section 1.1](http://www.ietf.org/rfc/rfc4244.txt).</span></span> <span data-ttu-id="c85d0-355">Per Microsoft Phone System, questa intestazione viene usata negli scenari di simulring e inoltro di chiamata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-355">For Microsoft Phone System, this header is used in Simulring and Call Forwarding scenarios.</span></span>  

<span data-ttu-id="c85d0-356">Se si invia, la History-Info è abilitata nel modo seguente:</span><span class="sxs-lookup"><span data-stu-id="c85d0-356">If sending, the History-Info is enabled as follows:</span></span>

- <span data-ttu-id="c85d0-357">Il proxy SIP inserirà un parametro contenente il numero di telefono associato nelle singole voci History-Info che costituiscono l'intestazione History-Info messaggio inviato al controller PSTN.</span><span class="sxs-lookup"><span data-stu-id="c85d0-357">The SIP proxy will insert a parameter containing the associated phone number in individual History-Info entries that comprise the History-Info header sent to the PSTN Controller.</span></span>  <span data-ttu-id="c85d0-358">Usando solo le voci che hanno il parametro numero di telefono, il controller PSTN ricostruirà una nuova intestazione History-Info e la passerà al provider trunk SIP tramite proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="c85d0-358">Using only entries that have the phone number parameter, the PSTN Controller will rebuild a new History-Info header, and pass it on to the SIP trunk provider via SIP proxy.</span></span>

- <span data-ttu-id="c85d0-359">History-Info'intestazione verrà aggiunta per i casi simultanei di squillo e inoltro di chiamata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-359">History-Info header will be added for simultaneous ring and call forwarding cases.</span></span>

- <span data-ttu-id="c85d0-360">History-Info'intestazione non verrà aggiunta per i casi di trasferimento di chiamata.</span><span class="sxs-lookup"><span data-stu-id="c85d0-360">History-Info header will not be added for call transfer cases.</span></span>

- <span data-ttu-id="c85d0-361">Una singola voce della cronologia nell'intestazione History-Info ricostruito avrà il parametro del numero di telefono fornito in combinazione con il nome fqdn (sip.pstnhub.microsoft.com) di routing diretto impostato come parte host dell'URI. nell'URI SIP verrà aggiunto un parametro "utente=telefono".</span><span class="sxs-lookup"><span data-stu-id="c85d0-361">An individual history entry in the reconstructed History-Info header will have the phone number parameter provided combined with the Direct Routing FQDN (sip.pstnhub.microsoft.com) set as the host part of the URI; a parameter of ‘user=phone’ will be added as part of the SIP URI.</span></span>  <span data-ttu-id="c85d0-362">Tutti gli altri parametri associati all'intestazione History-Info, ad eccezione dei parametri di contesto del telefono, verranno passati nell'intestazione History-Info telefono.</span><span class="sxs-lookup"><span data-stu-id="c85d0-362">Any other parameters associated with the original History-Info header, except for phone context parameters, will be passed through in the re-constructed History-Info header.</span></span>  

  > [!NOTE]
  > <span data-ttu-id="c85d0-363">Le voci private (come determinato dai meccanismi definiti nella Sezione 3.3 di RFC 4244) verranno inoltrate così come il provider trunk SIP è un peer attendibile.</span><span class="sxs-lookup"><span data-stu-id="c85d0-363">Entries that are private (as determined by the mechanisms defined in Section 3.3 of RFC 4244) will be forwarded as is because  the SIP trunk provider is a trusted peer.</span></span>

- <span data-ttu-id="c85d0-364">I messaggi in History-Info vengono ignorati.</span><span class="sxs-lookup"><span data-stu-id="c85d0-364">Inbound History-Info is ignored.</span></span>

<span data-ttu-id="c85d0-365">Di seguito è riportato il formato dell'intestazione History-info inviata dal proxy SIP:</span><span class="sxs-lookup"><span data-stu-id="c85d0-365">Following is the format of the History-info header sent by the SIP proxy:</span></span>

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

<span data-ttu-id="c85d0-366">Se la chiamata è stata reindirizzata più volte, le informazioni su ogni reindirizzamento vengono incluse con il motivo appropriato in ordine cronologico.</span><span class="sxs-lookup"><span data-stu-id="c85d0-366">If the call was redirected several times, information about every redirect is included with the appropriate reason in chronological order.</span></span>


<span data-ttu-id="c85d0-367">Esempio di intestazione:</span><span class="sxs-lookup"><span data-stu-id="c85d0-367">Header Example:</span></span>

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

<span data-ttu-id="c85d0-368">Il History-Info è protetto da un meccanismo TLS obbligatorio.</span><span class="sxs-lookup"><span data-stu-id="c85d0-368">The History-Info is protected by a mandatory TLS mechanism.</span></span> 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a><span data-ttu-id="c85d0-369">Connessione SBC al meccanismo di routing diretto e failover</span><span class="sxs-lookup"><span data-stu-id="c85d0-369">SBC connection to Direct Routing and failover mechanism</span></span>

<span data-ttu-id="c85d0-370">Vedere la sezione Meccanismo di failover per la segnalazione SIP in [Pianificare il routing diretto.](direct-routing-plan.md#failover-mechanism-for-sip-signaling)</span><span class="sxs-lookup"><span data-stu-id="c85d0-370">See the section Failover mechanism for SIP signaling in [Plan for Direct Routing](direct-routing-plan.md#failover-mechanism-for-sip-signaling).</span></span>

## <a name="retry-after"></a><span data-ttu-id="c85d0-371">Retry-After</span><span class="sxs-lookup"><span data-stu-id="c85d0-371">Retry-After</span></span>

<span data-ttu-id="c85d0-372">Se un data center Di routing diretto è occupato, il servizio può inviare un messaggio di Retry-After con un intervallo di un secondo all'SBC.</span><span class="sxs-lookup"><span data-stu-id="c85d0-372">If a Direct Routing datacenter is busy, the service can send a Retry-After message with a one-second interval to the SBC.</span></span> <span data-ttu-id="c85d0-373">Quando L'SBC riceve un messaggio 503 con un'intestazione Retry-After in risposta a un invito, deve terminare la connessione e provare il successivo data center Microsoft disponibile.</span><span class="sxs-lookup"><span data-stu-id="c85d0-373">When the SBC receives a 503 message with a Retry-After header in response to an INVITE, the SBC must terminate that connection and try the next available Microsoft datacenter.</span></span>

## <a name="handling-retries-603-response"></a><span data-ttu-id="c85d0-374">Gestione dei tentativi (risposta 603)</span><span class="sxs-lookup"><span data-stu-id="c85d0-374">Handling retries (603 response)</span></span>
<span data-ttu-id="c85d0-375">Se un utente finale osserva diverse chiamate perse per una chiamata dopo aver declinato la chiamata in arrivo, significa che il meccanismo di ripetizione dei tentativi del provider trunk SBC o PSTN non è configurato correttamente.</span><span class="sxs-lookup"><span data-stu-id="c85d0-375">If an end user observes several missed calls for one call after declining the incoming call, it means that the SBC or PSTN trunk provider's retry mechanism is misconfigured.</span></span> <span data-ttu-id="c85d0-376">L'SBC deve essere riconfigurato per interrompere i tentativi nella risposta 603.</span><span class="sxs-lookup"><span data-stu-id="c85d0-376">The SBC must be reconfigured to stop the retry efforts on the 603 response.</span></span>

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a><span data-ttu-id="c85d0-377">Riavvio ICE: chiamata bypass multimediale trasferita a un endpoint che non supporta il bypass multimediale</span><span class="sxs-lookup"><span data-stu-id="c85d0-377">ICE Restart: Media bypass call transferred to an endpoint that does not support media bypass</span></span>

<span data-ttu-id="c85d0-378">SBC deve supportare i riavvii ICE come descritto in [RFC 5245, sezione 9.1.1.1.](https://tools.ietf.org/html/rfc5245#section-9.1.1.1)</span><span class="sxs-lookup"><span data-stu-id="c85d0-378">The SBC must support ICE restarts as described in [RFC 5245, section 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1).</span></span>

<span data-ttu-id="c85d0-379">Il riavvio in Direct Routing viene implementato in base ai paragrafi seguenti della RFC:</span><span class="sxs-lookup"><span data-stu-id="c85d0-379">The restart in Direct Routing is implemented according to the following paragraphs of the RFC:</span></span>

<span data-ttu-id="c85d0-380">*Per riavviare ICE, un agente DEVE modificare sia ice-pwd che ice-ufrag per il flusso multimediale in un'offerta.  Si noti che è consentito usare un attributo a livello di sessione in un'offerta, ma fornire lo stesso ice-pwd o ice-ufrag come attributo a livello di media in un'offerta successiva.  Non si tratta di una modifica della password, ma di una modifica della relativa rappresentazione e non causa un riavvio ICE.*</span><span class="sxs-lookup"><span data-stu-id="c85d0-380">*To restart ICE, an agent MUST change both the ice-pwd and the ice-ufrag for the media stream in an offer.  Note that it is permissible to use a session-level attribute in one offer, but to provide the same ice-pwd or ice-ufrag as a media-level attribute in a subsequent offer.  This is not a change in password, just a change in its representation, and does not cause an ICE restart.*</span></span>

<span data-ttu-id="c85d0-381">*Un agente imposta il resto dei campi nel file SDP per questo flusso multimediale come in un'offerta iniziale di questo flusso multimediale (vedere la Sezione 4.3).  Di conseguenza, l'insieme di candidati PUÒ includere alcuni, nessuno o tutti i candidati precedenti per tale flusso e PUÒ includere un set completamente nuovo di candidati raccolti come descritto nella sezione 4.1.1.*</span><span class="sxs-lookup"><span data-stu-id="c85d0-381">*An agent sets the rest of the fields in the SDP for this media stream as it would in an initial offer of this media stream (see Section 4.3).  Consequently, the set of candidates MAY include some, none, or all of the previous candidates for that stream and MAY include a totally new set of candidates gathered as described in Section 4.1.1.*</span></span>

<span data-ttu-id="c85d0-382">Se la chiamata è stata inizialmente stabilita con bypass multimediale e la chiamata viene trasferita a un client Skype for Business, Direct Routing deve inserire un processore multimediale, perché il routing diretto non può essere usato con un client Skype for Business con bypass multimediale.</span><span class="sxs-lookup"><span data-stu-id="c85d0-382">If the call was initially established with media bypass, and the call is transferred to a Skype for Business client, Direct Routing needs to insert a Media Processor--this is because Direct Routing cannot be used with a Skype for Business client with media bypass.</span></span> <span data-ttu-id="c85d0-383">Direct Routing avvia il processo di riavvio ice modificando ice-pwd e ice-ufrag e offrendo nuovi media candidate in un rinvio.</span><span class="sxs-lookup"><span data-stu-id="c85d0-383">Direct Routing starts the ICE restart process by  changing the ice-pwd and ice-ufrag and offering new media candidates in a reinvite.</span></span>
